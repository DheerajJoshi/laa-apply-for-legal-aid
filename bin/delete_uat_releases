#!/usr/bin/env bash

PREFIX='apply-'
REPO_URL=https://api.github.com/repos/ministryofjustice/laa-apply-for-legal-aid/pulls
KUBE_ENV_UAT_NAMESPACE=laa-apply-for-legalaid-uat

OPEN_PRS=$(curl -s $REPO_URL | jq -c -r '.[] | .head.ref | gsub("[/_.]"; "-")')

UAT_RELEASES=$(helm list --tiller-namespace=laa-apply-for-legalaid-uat --all --output json)
ACTIVE_NAMESPACES=$(echo $UAT_RELEASES | jq -c -r '. | .Releases [] | select(.Name != "apply-master" ) | .Name')

function pr_has_closed() {
    TRIM_NAME=$(echo $1 | sed -En s/$PREFIX/''/p)

    if [[ $OPEN_PRS[@] =~ $TRIM_NAME ]]; then
        return 1
    else
        return 0
    fi
}

for environment in $(echo "$ACTIVE_NAMESPACES"); do
    if pr_has_closed $environment; then
      helm --tiller-namespace=$KUBE_ENV_UAT_NAMESPACE delete $environment --dry-run
    else
      echo "PR still open, retaining the `$environment` environment"
    fi
done
