#!/usr/bin/env bash
echo "Logging into RDS"

regex_manual='apply-manual-snapshot'

regex_automatic='rds:cloud-platform'

unset AWS_PROFILE

read AWS_ACCESS_KEY_ID name pass user addr endp AWS_SECRET_ACCESS_KEY url \
      <<<$(kubectl -n laa-apply-for-legalaid-staging get secret apply-for-legal-aid-rds-instance-output -o json | jq -r '.data[] | @base64d')

export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY


# uncomment the line below to print a list of the current backups to the console
aws rds describe-db-snapshots --db-instance-identifier cloud-platform-464651662c253592 | jq -r '.DBSnapshots[] | "\(.DBSnapshotIdentifier) created at \(.SnapshotCreateTime)"'

# snapshots="$(aws rds describe-db-snapshots --db-instance-identifier cloud-platform-464651662c253592 \
#                   | jq -r '.DBSnapshots[] | "\(.DBSnapshotIdentifier) created at \(.SnapshotCreateTime)"')"

manual_snapshots=$(aws rds describe-db-snapshots --db-instance-identifier cloud-platform-464651662c253592 \
                  | jq -r '.DBSnapshots[] | "\(.DBSnapshotIdentifier)"' | grep $regex_manual )

snapshot_count=$(aws rds describe-db-snapshots --db-instance-identifier cloud-platform-464651662c253592 \
                  | jq -r '.DBSnapshots[] | "\(.DBSnapshotIdentifier)"' | grep $regex_automatic | wc -l)

man_snap_count=$(aws rds describe-db-snapshots --db-instance-identifier cloud-platform-464651662c253592 \
                  | jq -r '.DBSnapshots[] | "\(.DBSnapshotIdentifier)"' | grep $regex_manual | wc -l)

echo 'There are' $man_snap_count 'hourly backups'

echo 'There are' $snapshot_count 'automatic daily DB backups'

if [ $man_snap_count -gt 4 ]
    then
      echo "$man_snap_count is greater than 4 you should delete some backups"
      # counter=$man_snap_count
      counter=$man_snap_count
      # while[ $counter -gt 2 ]
      while [ $counter -gt 4 ]
      do
        for i in $manual_snapshots;
        do
          (aws rds delete-db-snapshot --db-snapshot-identifier $i)
          ((counter--))
          echo $i 'has been deleted'
        done
      done
    else
      echo "No need to delete any backups today"
fi
# for i in $manual_snapshots; do (aws rds delete-db-snapshot --db-snapshot-identifier $i)
# $man_snap_count-- ; done

# echo $man_snap_count
