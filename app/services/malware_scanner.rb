class MalwareScanner
  ClamdscanError = Class.new(StandardError)

  def self.call(file_path)
    new(file_path).call
  end

  COMMAND = %w[clamdscan --fdpass --no-summary].freeze

  attr_reader :file_path, :uploader, :file_details

  def initialize(file_path:, uploader:, file_details: nil)
    @file_path = file_path
    @uploader = uploader
    @file_details = file_details
  end

  def call
    MalwareScanResult.new(
      uploader: uploader,
      virus_found: virus_found?,
      scan_result: scan_result.stdout,
      file_details: file_details
    ).tap(&:save!)
  end

  def virus_found?
    @virus_found ||= !scan_result.status.success?
  end

  def scan_result
    @scan_result ||= begin
      stdout, stderr, status = Open3.capture3(*(COMMAND + [file_path.to_s]))

      raise ClamdscanError, stderr if stderr.present?

      OpenStruct.new(
        stdout: stdout.strip,
        status: status
      )
    end
  end
end
